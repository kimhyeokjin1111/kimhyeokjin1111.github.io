<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>DM with <th:block th:text="${recipientId}"></th:block></title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6ecf4a;
            --border-color: #eee;
            --background-color: #f8f9fa;
            --text-color: #333;
            --message-bg-me: var(--primary-color);
            --message-bg-other: #ffffff;
            --message-text-me: #ffffff;
            --message-text-other: #333;
        }

        body {
            padding-top: 130px; /* Adjust for fixed header */
            margin: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh);
        }

        .chat-container {
            max-width: 800px;
            width: 100%;
            margin: 70px auto;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background: #fff;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header a {
            font-size: 0.9em;
            color: #666;
            text-decoration: none;
        }
        .chat-header a:hover {
            color: var(--primary-color);
        }

        .msgArea { /* Renamed to chat-messages */
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #f8f9fa;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
        }

        .message-wrapper.my-message {
            align-items: flex-end;
        }

        .message-wrapper.other-message {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            overflow-wrap: break-word;
        }

        .message-time {
            font-size: 0.75em;
            color: #888;
            margin-top: 4px; /* 버블 아래에 위치하므로 상단 여백 추가 */
        }

        .my-message .message-bubble {
            background-color: var(--message-bg-me);
            color: var(--message-text-me);
            border-bottom-right-radius: 4px;
        }

        .other-message .message-bubble {
            background-color: var(--message-bg-other);
            color: var(--message-text-other);
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }

        .msgArea img, .msgArea video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 8px;
            display: block;
        }
        .my-message .message-bubble img, .my-message .message-bubble video {
            background-color: var(--primary-color);
        }

        .message-sender {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 4px;
            padding: 0 5px;
        }

        .chat-input-form {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid var(--border-color);
            background-color: #fff;
        }

        .chat-input-form .content {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input-form .content:focus {
            border-color: var(--primary-color);
        }

        .chat-input-form button, .chat-input-form label {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            transition: color 0.2s;
        }
        .chat-input-form button:hover, .chat-input-form label:hover {
            color: var(--primary-color);
        }
        .chat-input-form .material-icons {
            font-size: 28px;
        }
        #mediaFile {
            display: none;
        }

        #send-btn {
            color: var(--primary-color);
        }

        .system-message {
            text-align: center;
            font-style: italic;
            color: #888;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .product-info-bar {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fafafa;<img class="product-image"
                     th:src="${product.productImage != null ? product.productImage : '/images/no-image.png'}"
                     alt="상품 이미지">
        }
        .product-info-bar .product-img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            object-fit: cover;
            margin-right: 15px;
        }
        .product-details {
            flex-grow: 1;
        }
        .product-title {
            font-weight: bold;
            font-size: 1em;
            color: #333;
        }
        .product-price {
            color: #555;
            font-size: 0.9em;
        }
        .view-product-btn {
            padding: 8px 12px;
            background-color: #75b85b;
            color: #eee;
            text-decoration: none;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
            border: 1px solid #ddd;
            transition: background-color 0.2s;
        }
        .view-product-btn:hover {
            background-color: #62a349;
        }

    </style>
</head>
<body>
    <header th:replace="~{header :: mainHeader}"></header>
	<script th:src="@{/js/chat-websocket.js}"
		sec:authorize="isAuthenticated()"></script>
	<div class="chat-container">
        <div class="chat-header">
            <span>상대방 : <th:block th:text="${recipientId}"></th:block></span>
            <a th:href="@{/chat/list}">목록 보기</a>
        </div>

        <!-- Product Info Bar -->
        <div class="product-info-bar" th:if="${product != null}">
        <img th:src="${product.productImage != null ? product.productImage : '/images/no-image.png'}" alt="상품 이미지" class="product-img"/>
            <div class="product-details">
                <div class="product-title" th:text="${product.title}">상품 제목</div>
                <div class="product-price" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '원'}">가격</div>
            </div>
            <a th:href="@{/products/info/{id}(id=${product.productId})}" class="view-product-btn">상품보기</a>
        </div>
        
        <div class="msgArea">
            <!-- Messages will be loaded here by JavaScript -->
        </div>
        <div class="chat-input-form">
            <label for="mediaFile" role="button" aria-label="Attach media">
                <i class="material-icons">attach_file</i>
            </label>
            <input type="file" id="mediaFile" accept="image/*,video/*">
            <input type="text" placeholder="메세지를 입력하세요." class="content">
            <button id="send-btn" type="button" onclick="sendMsg()">
                <i class="material-icons">send</i>
            </button>
        </div>
    </div>


<script th:inline="javascript">
    console.log("dm.html script executed.");
    /*<![CDATA[*/
    const senderId = [[${senderId}]];
    const recipientId = [[${recipientId}]];
    const productId = [[${productId}]];
    const historicalMessages = /*[[${messages}]]*/ [];
    /*]]>*/

    console.log("DM Initialized. Sender:", senderId, "Recipient:", recipientId, "Product ID:", productId);
    console.log("Historical Messages from server (raw):", historicalMessages);

    const msgArea = document.querySelector('.msgArea');
    const contentInput = document.querySelector('.content');
    const mediaFileInput = document.getElementById('mediaFile');

    window.displayMessage = function(msgObj) {
        console.log("[displayMessage] Received object:", msgObj);

        const messageSender = msgObj.sender || msgObj.senderId;
        const messageContent = msgObj.msg || msgObj.content;
        const messageType = msgObj.type;
        console.log(`[displayMessage] Details - Sender: ${messageSender}, Type: ${messageType}, Content: ${messageContent}`);

        // System messages
        if (messageSender === 'system') {
            const systemDiv = document.createElement('div');
            systemDiv.classList.add('system-message');
            systemDiv.innerText = messageContent;
            msgArea.appendChild(systemDiv);
            msgArea.scrollTop = msgArea.scrollHeight;
            return;
        }

        const wrapper = document.createElement('div');
        wrapper.classList.add('message-wrapper');

        const isMyMsg = messageSender === senderId;
        wrapper.classList.add(isMyMsg ? 'my-message' : 'other-message');

        if (!isMyMsg) {
            const senderName = document.createElement('div');
            senderName.classList.add('message-sender');
            senderName.innerText = messageSender;
            wrapper.appendChild(senderName);
        }

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        let messageElement;
        if (messageType === 'IMAGE') {
            messageElement = document.createElement('img');
            messageElement.src = messageContent;
        } else if (messageType === 'VIDEO') {
            messageElement = document.createElement('video');
            messageElement.src = messageContent;
            messageElement.controls = true;
        } else { // TALK
            messageElement = document.createElement('span');
            messageElement.innerText = messageContent;
        }

        bubble.appendChild(messageElement);
        wrapper.appendChild(bubble); // wrapper에 bubble을 직접 추가

        // 시간 표시 로직
        if (msgObj.sentAtFormatted) {
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('message-time');
            timeSpan.innerText = msgObj.sentAtFormatted;
            wrapper.appendChild(timeSpan); // wrapper에 timeSpan을 직접 추가
        }

        console.log("[displayMessage] Appending to msgArea:", wrapper);
        msgArea.append(wrapper);
        msgArea.scrollTop = msgArea.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        function getMessageTypeFromContent(content) {
            if (typeof content !== 'string') return 'TALK';
            if (content.startsWith('/chat-media/')) {
                const lowerCaseContent = content.toLowerCase();
                if (lowerCaseContent.endsWith('.jpg') || lowerCaseContent.endsWith('.jpeg') || lowerCaseContent.endsWith('.png') || lowerCaseContent.endsWith('.gif')) {
                    return 'IMAGE';
                }
                if (lowerCaseContent.endsWith('.mp4') || lowerCaseContent.endsWith('.webm') || lowerCaseContent.endsWith('.ogg')) {
                    return 'VIDEO';
                }
            }
            return 'TALK';
        }

        console.log("DOMContentLoaded: Loading historical messages...");
        for (const msg of historicalMessages) {
            const adaptedMsg = {
                senderId: msg.senderId,
                content: msg.content,
                type: getMessageTypeFromContent(msg.content),
                sentAtFormatted: msg.sentAtFormatted // 포맷된 시간 전달
            };
            window.displayMessage(adaptedMsg);
        }
        console.log("DOMContentLoaded: Historical messages loaded.");

        document.addEventListener('chat:message', function(event) {
            const msg = event.detail;
            console.log("DM page received 'chat:message' event:", msg);

            const isMyMessage = msg.sender === senderId && msg.recipientId === recipientId;
            const isTheirMessage = msg.sender === recipientId && msg.recipientId === senderId;
            const isSameProduct = String(msg.productId) === String(productId);

            if ((isMyMessage || isTheirMessage) && isSameProduct) {
                console.log("Message is for this room. Displaying...");
                 // 실시간 메시지 시간 포맷팅 (임시)
                msg.sentAtFormatted = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                window.displayMessage(msg);
            } else {
                console.log("Message is for another room. Ignoring display.");
            }
        });
    });


    window.sendMsg = function() {
        const content = contentInput.value;
        if (content.trim() === "") return;

        const dmMsg = {
            "type": "TALK",
            "sender": senderId,
            "recipientId": recipientId,
            "msg": content,
            "productId": productId
        };
        window.sendMessageOverSocket(dmMsg);
        contentInput.value = '';
    }

    window.sendMedia = async function() {
        const file = mediaFileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("/chat/upload", {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "File upload failed.");
            }

            const result = await response.json();
            const filePath = result.filePath;
            const fileType = file.type.startsWith('image/') ? 'IMAGE' : (file.type.startsWith('video/') ? 'VIDEO' : 'UNKNOWN');

            if (fileType === 'UNKNOWN') {
                alert("Unsupported file type.");
                return;
            }

            const dmMsg = {
                "type": fileType,
                "sender": senderId,
                "recipientId": recipientId,
                "msg": filePath,
                "productId": productId
            };
            window.sendMessageOverSocket(dmMsg);
        } catch (error) {
            console.error("Error sending media:", error);
            alert("Error sending media: " + error.message);
        } finally {
            mediaFileInput.value = ''; // Clear file input
        }
    }

    mediaFileInput.addEventListener('change', window.sendMedia); // Automatically send on file selection

    window.sendMessageOverSocket = function(msgObj) {
        if (typeof socket !== 'undefined' && socket.readyState === WebSocket.OPEN) {
            console.log("Sending message object via global socket:", msgObj);
            socket.send(JSON.stringify(msgObj));
        } else {
            console.error("Global WebSocket is not connected or not available.");
            let errorMsg = "Cannot send message. Connection is not available.";
             if (typeof socket === 'undefined') {
                errorMsg = "WebSocket is not initialized. Please refresh the page.";
            } else if (socket.readyState === WebSocket.CONNECTING) {
                errorMsg = "WebSocket is still connecting. Please wait a moment.";
            } else if (socket.readyState === WebSocket.CLOSING || socket.readyState === WebSocket.CLOSED) {
                errorMsg = "WebSocket is closed or closing. Please refresh the page.";
            }
            // Display system message instead of alert
            window.displayMessage({ sender: 'system', content: errorMsg });
        }
    }

    contentInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default action (like form submission)
            window.sendMsg();
        }
    });

</script>
<script th:src="@{/js/header.js}"></script>
</body>
</html>