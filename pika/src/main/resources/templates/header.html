<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
</head>
<body>
<header th:fragment="mainHeader" id="main-header">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <div class="header-auth">
        <div>
            <span sec:authorize="!isAuthenticated()">
                <a href="/user/login" id="login">ë¡œê·¸ì¸</a>
                <a href="/user/join" id="join">íšŒì›ê°€ì…</a>
            </span>
            <span sec:authorize="isAuthenticated()">
                <a href="/user/logout" id="logout">ë¡œê·¸ì•„ì›ƒ</a>
                <a href="/user/add-info" id="modify">ì •ë³´ìˆ˜ì •</a>
            </span>
        </div>
    </div>

    <div id="header-top">
        <div id="header-main-content">
            <a id="logo-link" th:href="@{/}">pika í”¼ì¹´</a>

            <div id="search-bar">
                <form th:action="@{/search}" method="get">
                    <!--urlì— category íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìˆ¨ê²¨ì§„ inputì— ì¶”ê°€-->
                   <input th:if="${param.category != null and not #strings.isEmpty(param.category)}" type="hidden"
                        name="category" th:value="${param.category}"/>
                    <!--category íŒŒë¼ë¯¸í„° ìœ ë¬´ì— ë”°ë¼ placeholder í…ìŠ¤íŠ¸ ë™ì ìœ¼ë¡œ ì„¤ì •-->
                    <th:block th:with="placeholderText=${(param.category != null and not
                        #strings.isEmpty(param.category)) ? param.category + ' ìƒí’ˆê²€ìƒ‰' : 'ê²€ìƒ‰í•  ìƒí’ˆì„ ì…ë ¥í•˜ì„¸ìš”.'}">
                        <input type="text" name="keyword" th:placeholder="${placeholderText}" class="search-input">
                    </th:block>
                    <button type="submit" style="background:none; border:none; padding:0">
                        <img th:src="@{/icon/search.svg}" alt="ê²€ìƒ‰">
                    </button>
                </form>
                <div id="popular-searches-container" style="display: none;">
                    <h5>ì¸ê¸° ê²€ìƒ‰ì–´</h5>
                    <ul id="popular-searches-list">
                    </ul>
                </div>
            </div>
        </div>
				<ul id="main-nav-menu">
					<li th:style="${#authorization.expression('!isAuthenticated')} ? 'visibility: hidden; pointer-event: none;' : ''">
					<a th:href="@{/chat/list}">ì±„íŒ…</a></li>
                    <li id="notification-btn" th:style="${#authorization.expression('!isAuthenticated')} ? 'visibility: hidden; pointer-event: none;' : ''">
                        <a href="#">ì•Œë¦¼</a>
                        <span id="notification-count" class="notification-count"></span>
                        <div id="notification-list">
                            <ul id="notification-items">
                            </ul>
                            <div id="notification-pagination">
                                <button id="prev-notification-page">ì´ì „</button>
                                <button id="next-notification-page">ë‹¤ìŒ</button>
                            </div>
                        </div>
                    </li>
					<li><a th:href="@{/products/new}">íŒë§¤í•˜ê¸°</a></li>
					<li><a th:href="@{/user/mypage}">ë§ˆì´í˜ì´ì§€</a></li>
				</ul>
			</div>
		</div>

    <div id="category-bar">
        <div id="category-wrapper">
            <div id="hamburger-icon">
                <img th:src="@{/icon/hamburger-icon.png}">
            </div>
            <div id="category-dropdown">
                <p>ì „ì²´ ì¹´í…Œê³ ë¦¬</p>

                <div class="category-item"
                     th:each="category : ${categoriesMap}"
                     th:if="${category.key != 'ì„œì ' and category.key != 'ì˜ë¥˜'}">

                    <a th:href="@{/search(category=${category.key})}"
                       th:text="${category.key}"></a>

                    <div class="submenu">
                        <p class="submenu-title" th:text="${category.key}"></p>
                        <th:block th:each="subCategory : ${category.value}">
                            <a th:href="@{/search(category=${category.key + '>' + subCategory})}"
                               th:text="${subCategory}"></a>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
        <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ììš©) ë²„íŠ¼ - currentUserRoleì´ ADMINì¼ ë•Œë§Œ í‘œì‹œ -->
        <a th:if="${currentUserRole != null and currentUserRole == 'ADMIN'}" th:href="@{/products}" class="nav-link" style="margin-left: auto; align-self: center; padding: 0 15px;">ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ììš©)</a>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ê³ ì • ë©”ë‰´ -->
    <div id="header-bottom-menu">
        <div id="favorite-link">
            <p>ì°œí•œ ìƒí’ˆ</p>
            <img th:src="@{/icon/heart.png}">
        </div>

        <div class="slider_fp_wrap" sec:authorize="isAuthenticated()">
            <div class="slider_fp_img">
                <div class="slider_fp_inner">
                    <!-- ì°œí•œ ìƒí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </div>
            </div>
            <div class="slider_fp_btn">
                <button class="prev_fp"><span>&lt;</span></button>
                <button class="next_fp"><span>&gt;</span></button>
            </div>
            <div class="slider__dot">
            </div>
        </div>

        <div id="top-link">TOP</div>
    </div>

    <!-- AI ì±—ë´‡ í”Œë¡œíŒ… ë²„íŠ¼ ë° ì±„íŒ…ì°½ -->
    <div id="ai-chat-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: column; align-items: flex-end;">
        <!-- ì±„íŒ…ì°½ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
        <div id="ai-chat-window" style="display: none; width: 350px; height: 500px; background-color: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; margin-bottom: 15px;">
            <!-- í—¤ë” -->
            <div style="background-color: #FFD700; padding: 15px; display: flex; justify-content: space-between; align-items: center; color: #333; font-weight: bold;">
                <span>âš¡ í”¼ì¹´ AI ë„ìš°ë¯¸</span>
                <button onclick="toggleAiChat()" style="background: none; border: none; font-size: 18px; cursor: pointer;">Ã—</button>
            </div>

            <!-- ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="ai-chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 10px;">
                <div style="align-self: flex-start; background-color: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; max-width: 80%; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ìƒí’ˆ ì‹œì„¸ê°€ ê¶ê¸ˆí•˜ë‹¤ë©´ ë¬¼ì–´ë´ì£¼ì„¸ìš”! ğŸ˜„
                </div>
            </div>

            <!-- ì…ë ¥ ì˜ì—­ -->
            <div style="padding: 10px; border-top: 1px solid #eee; background-color: white; display: flex;">
                <input type="text" id="ai-chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;" onkeypress="if(event.key === 'Enter') sendAiMessage()">
                <button onclick="sendAiMessage()" style="margin-left: 10px; background-color: #FFD700; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;">ì „ì†¡</button>
            </div>
        </div>

        <!-- í”Œë¡œíŒ… ë²„íŠ¼ -->
        <button id="ai-chat-btn" onclick="toggleAiChat()" style="width: 60px; height: 60px; border-radius: 50%; background-color: #FFD700; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 24px;">
            ğŸ¤–
        </button>
    </div>

    <script>
        function toggleAiChat() {
            const chatWindow = document.getElementById('ai-chat-window');
            if (chatWindow.style.display === 'none') {
                chatWindow.style.display = 'flex';
                document.getElementById('ai-chat-input').focus();
            } else {
                chatWindow.style.display = 'none';
            }
        }

        async function sendAiMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            const messagesArea = document.getElementById('ai-chat-messages');

            if (!message) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            appendMessage(message, 'user');
            input.value = '';

            // ë¡œë”© í‘œì‹œ
            const loadingId = 'loading-' + Date.now();
            appendMessage('ë‹µë³€ ìƒì„± ì¤‘...', 'ai', loadingId);

            try {
                const response = await fetch('/api/chat/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();

                // AI ì‘ë‹µ í‘œì‹œ
                appendMessage(data.response, 'ai');

            } catch (error) {
                console.error('Error:', error);
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();
                appendMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ai');
            }
        }

        function appendMessage(text, sender, id = null) {
            const messagesArea = document.getElementById('ai-chat-messages');
            const div = document.createElement('div');

            if (id) div.id = id;

            div.style.padding = '10px';
            div.style.borderRadius = '10px';
            div.style.maxWidth = '80%';
            div.style.wordBreak = 'break-word';
            div.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
            div.style.lineHeight = '1.4';

            if (sender === 'user') {
                div.style.alignSelf = 'flex-end';
                div.style.backgroundColor = '#FFD700'; // ë…¸ë€ìƒ‰
                div.style.color = '#333';
                div.textContent = text;
            } else {
                div.style.alignSelf = 'flex-start';
                div.style.backgroundColor = '#fff';
                div.style.border = '1px solid #eee';
                div.style.color = '#333';

                // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©
                try {
                    div.innerHTML = marked.parse(text);
                } catch (e) {
                    console.error('Markdown parsing error:', e);
                    div.innerHTML = text.replace(/\n/g, '<br>');
                }
            }

            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
    </script>
        <script type="module" th:src="@{/js/notification/notification-websocket.js}" sec:authorize="isAuthenticated()"></script>
        <script th:src="@{/js/product/favorite-slider.js}" sec:authorize="isAuthenticated()"></script>
    </header>

    </body>
    </html>
